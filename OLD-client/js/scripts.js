var app=angular.module("escapeApp",["ngResource","ui.router"]).config(function(e,t){t.otherwise("/"),e.state("start",{url:"/",templateUrl:"/views/start.html",controller:"startController as startCtrl"}).state("game",{url:"/game",templateUrl:"/views/game.html",controller:"gameController as gameCtrl"})});app.factory("highScoresFactory",function(e){var t={},a=e("/api/highScores");return t.saveHighScore=function(e,t){a.save({player:e,round:t})},t.getHighScores=function(){return a.query().$promise.then(function(e){return e})},t.getScoreToBeat=function(){return a.query().$promise.then(function(e){return e.length<10?0:e[9].round})},t}),app.factory("levelFactory",function(e){var t={},a={};return a.getLevels=function(){return e.get("js/levels.json").then(function(e){return e.data})},a.getLevel=function(){return t},a.setLevel=function(e){t=e},a}),app.factory("powerupFactory",function(e){var t={};return t.getPowerups=function(){return e.get("js/powerups.json").then(function(e){return e.data})},t}),app.controller("gameController",["$state","levelFactory","powerupFactory","highScoresFactory",function(e,t,a,n){function r(){clearInterval(X),clearInterval(Y)}function o(){Y=setInterval(M,be),X=setInterval(C,Math.floor(Math.random()*ke))}function s(e){W=new createjs.SpriteSheet({images:[me],frames:{width:64,height:64,regX:32,regY:32},animations:{walkRight:[0,2,"walkRight"],walkLeft:[3,5,"walkLeft"],walkUp:[0,2,"walkUp"],walkDown:[0,2,"walkDown"]}}),i(pe)}function c(){R=new createjs.Sprite(W);var e=u();R.x=e[0],R.y=e[1],A.addChild(R)}function i(e){clearInterval(X),clearInterval(Y),ue=[],V=!1,q=5,E=_.lightsOnSoundID,Q=_.enemySoundID,createjs.Sound.registerSound("../audio/"+_.lightsOnSound,E),createjs.Sound.registerSound("../audio/"+_.enemySound,Q),A=new createjs.Stage("canvas"),B=new createjs.Shape,B.graphics.ss(ae).s("black").f("black").r(0,0,ne,re),B.visible=!1,A.addChild(B),O=Math.floor(4*Math.random());var t=Math.floor(Math.random()*(ne-ee))+ee/2,n=Math.floor(Math.random()*(re-ee))+ee/2;switch(D=new createjs.Shape,O){case 0:T=[t,0],U=t-2*oe,H=t+2*oe,D.graphics.ss(ae).s(te).mt(t-ee/2,0).lt(t+ee/2,0).endStroke();break;case 1:T=[ne,n],U=n-2*oe,H=n+2*oe,D.graphics.ss(ae).s(te).mt(ne,n-ee/2).lt(ne,n+ee/2).endStroke();break;case 2:T=[t,re],U=t-2*oe,H=t+2*oe,D.graphics.ss(ae).s(te).mt(t-ee/2,re).lt(t+ee/2,re).endStroke();break;default:T=[0,n],U=n-2*oe,H=n+2*oe,D.graphics.ss(ae).s(te).mt(0,n-ee/2).lt(0,n+ee/2).endStroke()}A.addChild(D),a.getPowerups().then(function(e){for(var t=0;t<e.length;t++)ue.push(d(e[t].name,e[t].image,e[t].sound))}),c(),createjs.Ticker.addEventListener("tick",l),h(e,"images/"+_.enemyImages),A.update(),o()}function l(){G&&(R.x>=ce?R.x-=q:R.x>0?R.x=0:3==O&&R.y>U&&R.y<H&&V&&L()),J&&(R.x<=ne-ce-2*oe?R.x+=q:R.x<ne-2*oe?R.x=ne-2*oe:1==O&&R.y>U&&R.y<H&&V&&L()),K&&(R.y>=ce?R.y-=q:R.y>0?R.y=0:0==O&&R.x>U&&R.x<H&&V&&L()),N&&(R.y<=re-ce-2*oe?R.y+=q:R.y<re-2*oe?R.y=re-2*oe:2==O&&R.x>U&&R.x<H&&V&&L()),G&&!ye&&(R.gotoAndPlay("walkLeft"),ye=!0),J&&!ye&&(R.gotoAndPlay("walkRight"),ye=!0),K&&!ye&&(R.gotoAndPlay("walkUp"),ye=!0),N&&!ye&&(R.gotoAndPlay("walkDown"),ye=!0),x(),A.update()}function u(e){e="undefined"!=typeof e?e:20;var t=Math.floor(Math.random()*(ne-2*e))+e,a=Math.floor(Math.random()*(re-2*e))+e;return[t,a]}function d(e,t,a){var n=u();return p=new createjs.Bitmap("images/"+t),p.scaleX=.2,p.scaleY=.2,p.x=n[0],p.y=n[1],p.name=e,A.addChild(p),createjs.Sound.registerSound("../audio/"+a,e),p}function h(e,t){le=new Map;for(var a=0;e>a;a++){for(var n=u();Math.abs(R.x-n[0])<fe&&Math.abs(R.y-n[1])<fe;)n=u();var r=new createjs.Bitmap(t);r.scaleX=.7,r.scaleY=.7,r.x=n[0],r.y=n[1],le.set(a,r),A.addChild(r)}}function f(e,t){var a=Math.abs(e.x-t.x),n=Math.abs(e.y-t.y);return 2*oe>=a&&2*oe>=n}function g(){G=!0}function v(){K=!0}function m(){J=!0}function y(){N=!0}function k(){R.gotoAndStop("walkRight"),J=!1,ye=!1}function b(){R.gotoAndStop("walkLeft"),G=!1,ye=!1}function w(){R.gotoAndStop("walkUp"),K=!1,ye=!1}function S(){R.gotoAndStop("walkDown"),N=!1,ye=!1}function M(){if(!Z.isPaused){for(var e=0;e<le.size;e++){var t=le.get(e);if(R.isVisible()){var a=Math.abs(R.x-t.x),n=Math.abs(R.y-t.y);a>n?R.x>t.x?t.x+=se:t.x-=se:R.y>t.y?t.y+=se:t.y-=se,!de&&f(R,t)&&(r(),F())}else{var o=Math.floor(4*Math.random());switch(o){case 0:t.x-=se;break;case 1:t.x+=se;break;case 2:t.y-=se;break;case 3:t.y+=se}}}A.update()}}function x(){for(var e=0;e<ue.length;e++)I(ue[e])}function I(e){if(f(R,e)){j(e.name),A.removeChild(e),createjs.Sound.play(e.name);var t=ue.indexOf(e);t>-1&&ue.splice(t,1),A.update()}}function j(e){switch(e){case"speed":q*=2;break;case"cloak":ge=!0,R.visible=!1;break;case"shield":de=!0,z=setInterval(function(){de=!1,clearInterval(z)},he);break;case"key":V=!0}}function C(){if(!Z.isPaused){ie=!ie;for(var e=!1,t=0;t<le.size;t++){var a=le.get(t),n=Math.abs(R.x-a.x),r=Math.abs(R.y-a.y);ie&&!e&&we>n&&we>r&&(e=!0,createjs.Sound.play(Q)),a.visible=ie}for(var t=0;t<ue.length;t++)ue[t].visible=ie;ge||(R.visible=ie),ie?(createjs.Sound.play(E),B.visible=!1):B.visible=!0,clearInterval(X),X=setInterval(C,Math.floor(Math.random()*ke))}}function L(){i(++pe)}function P(){$("#highScoreForm").modal({keyboard:!1,backdrop:"static"}),ve=pe}function F(){n.getScoreToBeat().then(function(e){scoreToBeat=e,pe>=scoreToBeat?P():($("#gameOverModal").modal({keyboard:!1,backdrop:"static"}),$("#gameOverModal button").click(function(){$("#gameOverModal").modal("hide"),$(".modal-backdrop").remove()}))})}var A,B,D,O,T,U,H,R,q,X,Y,z,E,Q,V,G,J,K,N,W,Z=this,_=t.getLevel(),ee=50,te="red",ae=10,ne=1e3,re=582,oe=10,se=10,ce=2*oe,ie=!0,le=new Map,ue=[],de=!1,he=8e3,fe=150,ge=!1,pe=1,ve=0,me=new Image,ye=!1,ke=2e3,be=300,we=100;Z.legendItems=[],Z.highScores=[],Z.isPaused=!1,a.getPowerups().then(function(e){Z.legendItems=e}),me.onload=s,me.src="images/"+_.heroImages,Z.createHighScore=function(){n.saveHighScore(Z.player,ve),Z.player=""},Z.confirmQuit=function(){Z.pause()},Z.quit=function(){r(),$(".modal-backdrop").remove(),e.go("start")},Z.highScoresClick=function(){Z.pause(),n.getHighScores().then(function(e){Z.highScores=e})},Z.pause=function(){clearInterval(X),clearInterval(Y),Z.isPaused=!0},Z.resume=function(){o(),Z.isPaused=!1},Z.restart=function(){pe=1,i(pe)},$("#highScoreForm button[type='submit']").click(function(){Z.player&&Z.player.length>0&&($("#highScoreForm").modal("hide"),pe=1,i(pe))}),$(document).keydown(function(e){switch(e.keyCode){case 75:g();break;case 79:v();break;case 186:m();break;case 76:y();break;case 67:ge=!1,R.visible=!0}}),$(document).keyup(function(e){switch(e.keyCode){case 75:b();break;case 79:w();break;case 186:k();break;case 76:S()}})}]),app.controller("startController",["levelFactory",function(e){function t(){s=!s,s||createjs.Sound.play(o),$(".start-menu").toggleClass("start-menu-background","no-background"),$(".darkness").toggleClass("darkness-background","no-background"),clearInterval(r),r=a()}function a(){return setInterval(t,Math.floor(3e3*Math.random()))}var n=this;n.selectedLevel=1;var r,o="thunder",s=!0;createjs.Sound.registerSound("../audio/Thunder1.mp3",o),r=a(),e.getLevels().then(function(e){n.levels=e}),n.startLevel=function(){clearInterval(r);var t={};n.levels&&n.levels.length>0&&(t=n.levels[n.selectedLevel-1]),e.setLevel(t)}}]);